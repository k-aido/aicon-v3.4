# Make.com Setup Guide for Social Media Analysis

This guide provides comprehensive instructions for setting up Make.com scenarios to integrate with the AICON social media analysis webhooks.

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Webhook Configuration](#webhook-configuration)
3. [Platform-Specific Apify Setup](#platform-specific-apify-setup)
4. [Make.com Scenario Configuration](#makecom-scenario-configuration)
5. [Error Handling Setup](#error-handling-setup)
6. [AI Analysis Templates](#ai-analysis-templates)
7. [Testing Your Setup](#testing-your-setup)

## Prerequisites

Before starting, ensure you have:
- Make.com account with appropriate plan
- Apify account with API access
- AICON webhook endpoint URLs
- Valid webhook authentication tokens

### Required API Keys
```env
# Add to your .env file
MAKE_WEBHOOK_SECRET=your-webhook-secret
APIFY_API_TOKEN=your-apify-token
```

## Webhook Configuration

### 1. Webhook Endpoint URLs

Production:
```
https://your-app.com/api/webhooks/make
```

Development/Testing:
```
http://localhost:3000/api/webhooks/make
```

### 2. Authentication Setup

Generate a webhook token following this format:
```
svc_webhook_<accountId>_<randomString>
```

Example: `svc_webhook_acc123_a8f7b2c9d4e5f6`

### 3. Required Headers

Configure these headers in Make.com HTTP modules:
```json
{
  "Content-Type": "application/json",
  "Authorization": "Bearer <your-webhook-token>",
  "x-make-signature": "<calculated-hmac-signature>"
}
```

## Platform-Specific Apify Setup

### YouTube Configuration

1. **Apify Actor**: YouTube Scraper
   - Actor ID: `bernardo/youtube-scraper`
   - Input Schema:
   ```json
   {
     "startUrls": [
       {
         "url": "{{youtube_url}}"
       }
     ],
     "maxResults": 1,
     "extractComments": true,
     "extractSubtitles": true,
     "subtitlesLanguage": "en"
   }
   ```

2. **Output Mapping**:
   ```json
   {
     "title": "{{item.title}}",
     "description": "{{item.description}}",
     "viewCount": "{{item.viewCount}}",
     "likeCount": "{{item.likeCount}}",
     "commentCount": "{{item.commentCount}}",
     "duration": "{{item.duration}}",
     "uploadDate": "{{item.uploadDate}}",
     "channelName": "{{item.channelName}}",
     "channelId": "{{item.channelId}}",
     "transcript": "{{item.subtitles[0].text}}",
     "thumbnailUrl": "{{item.thumbnailUrl}}"
   }
   ```

### Instagram Configuration

1. **Apify Actor**: Instagram Scraper
   - Actor ID: `apify/instagram-scraper`
   - Input Schema:
   ```json
   {
     "directUrls": ["{{instagram_url}}"],
     "resultsType": "posts",
     "addParentData": true,
     "searchType": "url",
     "extendOutputFunction": "async ({ data, item, page, request, customData }) => {\n  return {\n    ...item,\n    caption: item.caption || item.alt_text,\n    metrics: {\n      likes: item.likesCount,\n      comments: item.commentsCount,\n      views: item.videoViewCount || 0\n    }\n  };\n}"
   }
   ```

2. **Profile Analysis Input**:
   ```json
   {
     "usernames": ["{{username}}"],
     "resultsType": "posts",
     "resultsLimit": 10,
     "addParentData": true
   }
   ```

### TikTok Configuration

1. **Apify Actor**: TikTok Scraper
   - Actor ID: `clockworks/tiktok-scraper`
   - Input Schema:
   ```json
   {
     "postURLs": ["{{tiktok_url}}"],
     "maxProfilesPerQuery": 1,
     "resultsPerPage": 1,
     "getVideoInfo": true
   }
   ```

2. **Output Mapping**:
   ```json
   {
     "title": "{{item.text}}",
     "viewCount": "{{item.playCount}}",
     "likeCount": "{{item.diggCount}}",
     "commentCount": "{{item.commentCount}}",
     "shareCount": "{{item.shareCount}}",
     "authorUsername": "{{item.authorMeta.name}}",
     "authorNickname": "{{item.authorMeta.nickName}}",
     "authorAvatar": "{{item.authorMeta.avatar}}",
     "musicTitle": "{{item.musicMeta.musicName}}",
     "hashtags": "{{item.hashtags}}"
   }
   ```

## Make.com Scenario Configuration

### Step 1: Create Main Scenario

1. **Trigger Module**: HTTP Webhook
   - Name: "Social Media Analysis Trigger"
   - Webhook URL: Generated by Make.com
   - Data structure: JSON with URL and platform

2. **Router Module**: Split by Platform
   - Route 1: YouTube
   - Route 2: Instagram  
   - Route 3: TikTok

### Step 2: Platform-Specific Flows

#### YouTube Flow
```
1. HTTP Webhook Trigger
   ↓
2. Router (Filter: platform = "youtube")
   ↓
3. HTTP Module - Create Job
   - URL: {{webhook_endpoint}}
   - Method: POST
   - Body: {
       "action": "job.create",
       "timestamp": "{{now}}",
       "execution_id": "{{executionId}}",
       "scenario_id": "{{scenarioId}}",
       "content": {
         "url": "{{1.url}}",
         "platform": "youtube"
       }
     }
   ↓
4. Apify - Run YouTube Scraper
   - Actor: bernardo/youtube-scraper
   - Input: See YouTube Configuration above
   ↓
5. HTTP Module - Process Content
   - URL: {{webhook_endpoint}}
   - Method: POST
   - Body: {
       "action": "content.process",
       "job_id": "{{3.job_id}}",
       "content_data": {
         "title": "{{4.title}}",
         "description": "{{4.description}}",
         "transcript": "{{4.subtitles[0].text}}",
         "metrics": {
           "views": {{4.viewCount}},
           "likes": {{4.likeCount}},
           "comments": {{4.commentCount}}
         }
       }
     }
```

#### Instagram Flow
```
1. HTTP Webhook Trigger
   ↓
2. Router (Filter: platform = "instagram")
   ↓
3. Tools - Set Variable
   - Variable: content_type
   - Value: {{if(contains(1.url, "/p/"), "post", "profile")}}
   ↓
4. HTTP Module - Create Job
   ↓
5. Apify - Run Instagram Scraper
   - Dynamic input based on content_type
   ↓
6. Iterator (if profile)
   - Array: {{5.posts}}
   ↓
7. HTTP Module - Process Content
   - For each post/content
```

#### TikTok Flow
Similar structure to Instagram with platform-specific adjustments.

### Step 3: Error Handling Configuration

Add these modules after each HTTP/Apify call:

1. **Error Handler Route**
   ```
   Error Handler → Sleep (30s) → Resume
   ```

2. **Retry Configuration**
   - Maximum attempts: 3
   - Delay between attempts: 30 seconds
   - Exponential backoff: enabled

3. **Final Error Handler**
   ```json
   {
     "action": "job.update",
     "job_id": "{{job_id}}",
     "status": "failed",
     "error": "{{error.message}}",
     "error_details": {
       "module": "{{error.module}}",
       "attempt": {{attempt_number}},
       "timestamp": "{{now}}"
     }
   }
   ```

## Error Handling Setup

### 1. Module-Level Error Handling

For each Apify module:
```
Settings → Error Handling → Continue
Add Error Route → Log Error → Update Job Status
```

### 2. Scenario-Level Settings

```
Scenario Settings:
- Sequential processing: Yes
- Max queue size: 100
- Timeout: 300 seconds
- Allow storing incomplete executions: Yes
```

### 3. Error Notification Setup

Add Email/Slack notification for critical errors:
```json
{
  "condition": "status = 'failed' AND attempt_number >= 3",
  "notification": {
    "channel": "slack",
    "message": "Social media analysis failed after 3 attempts: {{error.message}}"
  }
}
```

## AI Analysis Templates

### Hook Analysis Prompt Template
```
Analyze the hook (first 3-5 seconds or opening statement) of this {{platform}} content:

Title: {{title}}
Transcript/Caption: {{content_text}}

Provide:
1. Effectiveness score (0-1)
2. Hook type (question, statement, shock value, etc.)
3. Emotional triggers used
4. Attention-grabbing elements
5. 3 specific improvements
6. 2 alternative hook examples

Format as JSON.
```

### Body Analysis Prompt Template
```
Analyze the main content structure of this {{platform}} content:

Content: {{full_content}}
Duration: {{duration}}

Identify:
1. Structure type (problem-solution, storytelling, educational, etc.)
2. Key points (list max 5)
3. Flow score (0-1)
4. Clarity score (0-1)
5. Engagement tactics used
6. Pacing analysis (intro %, main %, conclusion %)

Format as JSON.
```

### CTA Analysis Prompt Template
```
Analyze the call-to-action in this {{platform}} content:

Content ending: {{last_30_seconds_or_final_paragraph}}

Extract:
1. Primary CTA (exact text)
2. Secondary CTAs (if any)
3. CTA strength (strong/moderate/weak/none)
4. Placement effectiveness (0-1)
5. Clarity score (0-1)
6. Urgency level
7. 3 recommendations for improvement

Format as JSON.
```

## Testing Your Setup

### 1. Test Individual Modules

YouTube Test:
```bash
curl -X POST https://hook.make.com/your-webhook-id \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    "platform": "youtube",
    "test": true
  }'
```

### 2. Monitor Execution

1. Open Make.com scenario history
2. Check each module's output
3. Verify webhook responses
4. Monitor Apify run status

### 3. Validate Database Updates

```sql
-- Check job creation
SELECT * FROM social_media_jobs 
WHERE external_job_id = 'your-execution-id'
ORDER BY created_at DESC;

-- Monitor job progress
SELECT id, status, processing_time_ms, error_message
FROM social_media_jobs
WHERE created_at > NOW() - INTERVAL '1 hour';
```

### 4. Common Test Scenarios

1. **Single YouTube Video**
   - Expected time: 30-45 seconds
   - Check transcript extraction

2. **Instagram Profile (10 posts)**
   - Expected time: 60-90 seconds
   - Verify batch processing

3. **Failed Apify Run**
   - Trigger by using invalid URL
   - Verify retry logic

4. **Rate Limit Test**
   - Send 5 requests rapidly
   - Check queuing behavior

## Performance Optimization

### 1. Parallel Processing

For profile analysis with multiple posts:
```
Iterator → Array Aggregator (batch size: 5) → HTTP Module (bulk update)
```

### 2. Caching Strategy

Add Data Store module to cache:
- Platform metadata
- Author information
- Previously analyzed content IDs

### 3. Webhook Optimization

```json
{
  "batch_size": 10,
  "compression": "gzip",
  "timeout": 30000,
  "retry_strategy": "exponential_backoff"
}
```

## Monitoring and Maintenance

### Weekly Tasks
1. Review failed job logs
2. Check Apify credit usage
3. Update actor versions
4. Clean up test data

### Monthly Tasks
1. Analyze performance metrics
2. Optimize slow scenarios
3. Update AI prompts based on results
4. Review rate limit settings

## Support Resources

- Make.com Documentation: https://www.make.com/en/help
- Apify Documentation: https://docs.apify.com
- AICON Webhook API: /api/webhooks/make/README.md
- Support Email: support@aicon.app